<dom-module id="grid-crud-demos">
  <template>
    <style include="vaadin-component-demo-shared-styles">
      :host {
        display: block;
      }
    </style>

    <style>
      vaadin-grid {
        text-transform: none;
      }
    </style>


    <h3>Create, Read, Update and Delete</h3>
    <p>
      Grid renderers and JavaScript functions can be used to implement inline editing.
    </p>
    <p>
      <b>Note:</b> Remember to call <code>grid.clearCache()</code> to show updated data.
    </p>
    <vaadin-demo-snippet id='grid-crud-demos-crud'>
      <template preserve-content>
        <style>
          vaadin-grid vaadin-text-field {
            width: 100%;
          }
        </style>
        <x-array-data-provider></x-array-data-provider>

        <div style="margin-bottom: 20px">
          <vaadin-text-field id="firstname" label="First Name"></vaadin-text-field>
          <vaadin-text-field id="lastname" label="Last Name"></vaadin-text-field>
          <vaadin-button id="add-btn">Add</vaadin-button>
        </div>

        <vaadin-grid theme="compact">
          <vaadin-grid-column resizable></vaadin-grid-column>
          <vaadin-grid-column resizable></vaadin-grid-column>
          <vaadin-grid-column width="12em" resizable></vaadin-grid-column>
          <vaadin-grid-column width="14em"></vaadin-grid-column>
        </vaadin-grid>
        <script>
          window.addDemoReadyListener('#grid-crud-demos-crud', function(document) {
            const grid = document.querySelector('vaadin-grid');
            const firstname = document.querySelector('#firstname');
            const lastname = document.querySelector('#lastname');

            const addBtn = document.querySelector('#add-btn');

            addBtn.addEventListener('click', function() {
              if (firstname.value && lastname.value) {
                grid.items.unshift({name: {first: firstname.value, last: lastname.value}});
                grid.clearCache();
                firstname.value = lastname.value = '';
              } else {
                alert('First Name and Last Name required');
              }
            });

            const columns = document.querySelectorAll('vaadin-grid-column');

            columns[0].headerRenderer = function(root) {
              root.textContent = 'First Name';
            };
            columns[0].renderer = function(root, column, model) {
              let textField = root.firstElementChild;
              if (!textField) {
                textField = new Vaadin.TextFieldElement();
                root.appendChild(textField);
              }
              textField.setAttribute('id', 'first-' + model.index);
              textField.value = model.item.name.first;
              textField.readonly = true;
            };

            columns[1].headerRenderer = function(root) {
              root.textContent = 'Last Name';
            };
            columns[1].renderer = function(root, column, model) {
              let textField = root.firstElementChild;
              if (!textField) {
                textField = new Vaadin.TextFieldElement();
                root.appendChild(textField);
              }
              textField.setAttribute('id', 'last-' + model.index);
              textField.value = model.item.name.last;
              textField.readonly = true;
            };

            columns[2].headerRenderer = function(root) {
              root.textContent = 'Email';
            };
            columns[2].renderer = function(root, column, model) {
              root.textContent = model.item.name.first + '.' + model.item.name.last + '@example.com';
            };

            columns[3].renderer = function(root, column, model) {
              let wrapper = root.firstElementChild;
              if (!wrapper) {
                root.innerHTML =
                  '<div style="text-align: right">' +
                    '<vaadin-button aria-label="Edit" theme="icon" focus-target>' +
                      '<iron-icon icon="lumo:edit"></iron-icon>' +
                    '</vaadin-button>' +
                    '<vaadin-button aria-label="Delete" theme="icon error" style="margin-left: 5px">' +
                      '<iron-icon icon="lumo:cross"></iron-icon>' +
                    '</vaadin-button>' +
                    '<vaadin-button aria-label="Save" theme="primary" focus-target hidden>Save</vaadin-button>' +
                    '<vaadin-button aria-label="Cancel" hidden style="margin-left: 5px">Cancel</vaadin-button>' +
                  '</div>';
                wrapper = root.firstElementChild;

                const buttons = wrapper.querySelectorAll('vaadin-button')
                buttons[0].addEventListener('click', function() {
                  grid.querySelector('#first-' + wrapper._model.index).focus();
                  updateTextFieldsVisibility(wrapper._model.index, true);
                  updateButtonsVisibility(wrapper, true);
                });
                buttons[1].addEventListener('click', function(event) {
                  var index = grid.items.indexOf(wrapper._model.item);
                  grid.items.splice(index, 1);
                  grid.clearCache();
                });
                buttons[2].addEventListener('click', function() {
                  model.item.name.first = grid.querySelector('#first-' + wrapper._model.index).value;
                  model.item.name.last = grid.querySelector('#last-' + wrapper._model.index).value;

                  updateTextFieldsVisibility(wrapper._model.index, false);
                  updateButtonsVisibility(wrapper, false);
                  grid.clearCache();
                  buttons[0].focus();
                });
                buttons[3].addEventListener('click', function(event) {
                  updateTextFieldsVisibility(wrapper._model.index, false);
                  updateButtonsVisibility(wrapper, false);
                  grid.clearCache();
                  buttons[0].focus();
                });
              }

              wrapper._model = model;
              console.log(model, root, root._model);
            };

            function updateTextFieldsVisibility(index, editing) {
              if (editing) {
                grid.querySelector('#first-' + index).removeAttribute('readonly');
                grid.querySelector('#last-' + index).removeAttribute('readonly');
              } else {
                grid.querySelector('#first-' + index).setAttribute('readonly', true);
                grid.querySelector('#last-' + index).setAttribute('readonly', true);
              }
            }

            function updateButtonsVisibility(wrapper, editing) {
              if (editing) {
                wrapper.querySelectorAll('[theme~="icon"]').forEach(function(btn) {
                  btn.setAttribute('hidden', true);
                });
                wrapper.querySelectorAll('vaadin-button:not([theme~="icon"])').forEach(function(btn) {
                  btn.removeAttribute('hidden');
                });
              } else {
                wrapper.querySelectorAll('[theme~="icon"]').forEach(function(btn) {
                  btn.removeAttribute('hidden');
                });
                wrapper.querySelectorAll('vaadin-button:not([theme~="icon"])').forEach(function(btn) {
                  btn.setAttribute('hidden', true);
                });
              }
            }

            const dataProvider = document.querySelector('x-array-data-provider');
            dataProvider.size = 200;
            grid.items = dataProvider.items;
          });
        </script>
      </template>
    </vaadin-demo-snippet>

  </template>
  <script>
    class GridCrudDemos extends DemoReadyEventEmitter(GridDemo(Polymer.Element)) {
      static get is() {
        return 'grid-crud-demos';
      }
    }
    customElements.define(GridCrudDemos.is, GridCrudDemos);
  </script>
</dom-module>
