<dom-module id="grid-hierarchy-demos">
  <template>
    <style>
       :host {
        display: block;
      }

    </style>


    <h3>Assigning Hierarchical Data Using Data Provider</h3>
    <vaadin-demo-snippet id="grid-hierarchy-demos-data-provider">
      <template preserve-content>
        <x-hierarchical-data-provider-example></x-hierarchical-data-provider-example>
        <dom-module id="x-hierarchical-data-provider-example">
          <template preserve-content>
            <vaadin-grid aria-label="Hierarchical Data Grid Example" data-provider="[[_dataProvider]]">

              <vaadin-grid-column>
                <template class="header">Package name</template>
                <template>
                  <vaadin-grid-hierarchy-toggle
                      enabled="[[item.hasChildren]]"
                      expanded="{{hierarchyExpanded}}"
                      level="[[hierarchyLevel]]">
                    [[item.name]]
                  </vaadin-grid-hierarchy-toggle>
                </template>
              </vaadin-grid-column>

              <vaadin-grid-column>
                <template class="header">Version specified</template>
                <template>[[item.version]]</template>
              </vaadin-grid-column>

            </vaadin-grid>
          </template>
          <script>
            window.addDemoReadyListener('#grid-hierarchy-demos-data-provider', function(document) {
              class XHierarchicalDataProviderExample extends Polymer.Element {
                static get is() {
                  return 'x-hierarchical-data-provider-example';
                }

                static get properties() {
                  return {
                    _dataProvider: {
                      type: Function,
                      value: () => {
                        return (params, callback) => {
                          const pkgName = params.parentItem ?
                            params.parentItem.name :
                            'vaadin-grid';
                          console.log('...', pkgName);
                          this._fetchDependencies(pkgName)
                            .then(dependencies => {
                              Promise.all(dependencies.map(pkg =>
                                this._fetchDependencies(pkg.name)
                                  .then(children => {
                                    pkg.hasChildren = children.length > 0;
                                    return pkg;
                                  })
                              )).then(dependencies => {
                                console.log(pkgName, dependencies);
                                callback(
                                  dependencies.slice(
                                    params.page * params.pageSize,
                                    (params.page + 1) * params.pageSize
                                  ),
                                  dependencies.length
                                );
                              });
                            });
                        };
                      }
                    }
                  };
                }

                static _fetchDependencies(packageName) {
                  return new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('GET', `${this.importPath}../../${packageName}/bower.json`);
                    xhr.onload = function() {
                      try {
                        const json = JSON.parse(this.responseText);
                        const deps = Object.keys(json.dependencies || []).map(dep => {
                          return {
                            name: dep,
                            version: json.dependencies[dep].split('#').pop()
                          };
                        });
                        resolve(deps);
                      } catch(e) {}
                    };
                    xhr.onerror = reject;
                    xhr.send();
                  });
                }
              }
              window.customElements.define(XHierarchicalDataProviderExample.is, XHierarchicalDataProviderExample);
            });
          </script>
        </dom-module>
      </template>
    </vaadin-demo-snippet>

  </template>
  <script>
    class GridHierarchyDemos extends DemoReadyEventEmitter(GridDemo(Polymer.Element)) {
      static get is() {
        return 'grid-hierarchy-demos';
      }
    }
    customElements.define(GridHierarchyDemos.is, GridHierarchyDemos);
  </script>
</dom-module>
