<!doctype html>

<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <script src="../../iron-test-helpers/mock-interactions.js"></script>

  <link rel="import" href="helpers.html">
  <link rel="import" href="../vaadin-grid.html">
  <link rel="import" href="../vaadin-grid-selection-column.html">
</head>

<body>

  <test-fixture id="default">
    <template>
      <vaadin-grid style="width: 200px; height: 200px;" size="10000">
        <vaadin-grid-column>
          <template>foo</template>
        </vaadin-grid-column>
        <vaadin-grid-column>
          <template>bar</template>
        </vaadin-grid-column>
      </vaadin-grid>
    </template>
  </test-fixture>
  <test-fixture id="multiselect">
    <template>
      <vaadin-grid style="width: 200px; height: 200px;" size="10000">
        <vaadin-grid-selection-column>
        </vaadin-grid-selection-column>
        <vaadin-grid-selection-column>
          <template class="header">header</template>
          <template>body</template>
        </vaadin-grid-selection-column>
        <vaadin-grid-column-group>
          <vaadin-grid-selection-column>
          </vaadin-grid-selection-column>
        </vaadin-grid-column-group>
      </vaadin-grid>
    </template>
  </test-fixture>

  <script>
    var grid;
    var rows;
    var cachedItems;

    describe('selection', function() {
      beforeEach(function() {
        grid = fixture('default');
        grid.dataSource = infiniteDataSource;
        cachedItems = grid._cache[0];
        rows = getRows(grid.$.scroller.$.items);
        grid.selectedItems = [cachedItems[0]];
        Polymer.dom.flush();
      });

      it('should set selected attribute', function() {
        expect(rows[0].hasAttribute('selected')).to.be.true;
        expect(rows[1].hasAttribute('selected')).to.be.false;
      });

      it('should bind to cells', function() {
        var cells = getRowCells(rows[0]);
        expect(cells[0].instance.selected).to.be.true;
        expect(cells[1].instance.selected).to.be.true;
        expect(getRowCells(rows[1])[0].instance.selected).to.be.false;
      });

      it('should reflect cell instance value', function() {
        var cells = getRowCells(rows[0]);
        cells[0].instance.selected = false;
        expect(cells[0].instance.selected).to.be.false;
        expect(grid.selectedItems).to.be.empty;
      });

      describe('selectedItems', function() {
        it('should reflect changes', function() {
          grid.push('selectedItems', cachedItems[1]);
          expect(rows[1].hasAttribute('selected')).to.be.true;
        });

        it('should notify', function(done) {
          grid.addEventListener('selected-items-changed', function() {
            done();
          });
          grid.selectedItems = [cachedItems[1]];
        });
      });

      describe('select functions', function() {
        it('should select item', function() {
          expect(grid._isSelected(cachedItems[1])).to.be.false;
          grid.selectItem(cachedItems[1]);
          expect(grid._isSelected(cachedItems[1])).to.be.true;
        });

        it('should deselect item', function() {
          expect(grid._isSelected(cachedItems[0])).to.be.true;
          grid.deselectItem(cachedItems[0]);
          expect(grid._isSelected(cachedItems[0])).to.be.false;
        });

        it('should select multiple rows', function() {
          grid.selectItem(cachedItems[1]);
          grid.selectItem(cachedItems[2]);
          expect(grid._isSelected(cachedItems[1])).to.be.true;
          expect(grid._isSelected(cachedItems[2])).to.be.true;
        });
      });
    });

    describe('multi selection column', function() {
      var headerRows;
      var firstHeaderCellContent, firstBodyCellContent;
      var selectionColumn;
      var selectAllCheckbox, firstBodyCheckbox;

      beforeEach(function() {
        grid = fixture('multiselect');
        grid.items = ['foo', 'bar', 'baz'];
        delete grid.dataSource;

        selectionColumn = grid._columnTree[0][0];
        cachedItems = grid._cache[0];
        rows = getRows(grid.$.scroller.$.items);
        headerRows = getRows(grid.$.scroller.$.header);

        firstHeaderCellContent = getCellContent(getRowCells(headerRows[1])[0]);
        firstBodyCellContent = getCellContent(getRowCells(rows[0])[0]);

        selectAllCheckbox = firstHeaderCellContent.children[0];
        firstBodyCheckbox = firstBodyCellContent.children[0];

        Polymer.dom.flush();
      });

      it('should have a checkbox in the body cell', function() {
        expect(firstBodyCheckbox.localName).to.eql('input');
        expect(firstBodyCheckbox.type).to.eql('checkbox');
      });

      it('should select item when checkbox is checked', function() {
        var selectCheckbox = firstBodyCheckbox;

        selectCheckbox.click();

        expect(grid._isSelected(cachedItems[0])).to.be.true;
      });

      it('should have bound the body checkbox to selected items', function() {
        var selectCheckbox = firstBodyCheckbox;

        grid.push('selectedItems', cachedItems[0]);

        expect(selectCheckbox.checked).to.be.true;
      });

      it('should have a select all checkbox in the header', function() {
        expect(selectAllCheckbox.localName).to.eql('input');
        expect(selectAllCheckbox.type).to.eql('checkbox');
      });

      it('should set selectAll when header checkbox is clicked', function() {
        selectAllCheckbox.click();

        expect(selectionColumn.selectAll).to.be.true;
      });

      it('should select all items when select all is set', function() {
        selectionColumn.selectAll = true;

        expect(grid.selectedItems).to.eql(grid.items);
      });

      it('should take filter into account when selecting all items', function() {
        grid.items = [{value: 'foo'}, {value: 'bar'}];
        grid._filters = [{path: 'value', value: 'f'}];

        selectionColumn.selectAll = true;

        expect(grid.selectedItems).to.eql([grid.items[0]]);
      });

      it('should deselect all items when select all is unset', function() {
        selectionColumn.selectAll = true;

        selectionColumn.selectAll = false;

        expect(grid.selectedItems).to.be.empty;
      });

      it('should set a copy of items when all items are selected', function() {
        selectionColumn.selectAll = true;

        grid.pop('selectedItems');

        expect(grid.items).not.to.eql(grid.selectedItems);
      });

      it('should not set selection when data source is used', function() {
        grid.items = undefined;
        grid.dataSource = infiniteDataSource;

        selectionColumn.selectAll = true;

        expect(grid.selectedItems).to.be.empty;
      });

      it('should hide select all checkbox when data source is used', function() {
        grid.items = undefined;
        grid.dataSource = infiniteDataSource;

        expect(selectAllCheckbox.hidden).to.be.true;
      });

      it('should be possible to override the body template', function() {
        var secondCell = getCellContent(getRowCells(rows[0])[1]);

        expect(secondCell.innerHTML).to.eql('body');
      });

      it('should be possible to override the header template', function() {
        var secondCell = getCellContent(getRowCells(headerRows[1])[1]);

        expect(secondCell.innerHTML).to.eql('header');
      });

      it('should have grid reference also when column is nested inside a group', function() {
        expect(grid._columnTree[1][2]._grid).to.eql(grid);
      });

      it('should not have indeterminate when nothing is selected', function() {
        expect(selectAllCheckbox.indeterminate).to.be.false;
      });

      it('should have indeterminate when an item is selected', function() {
        firstBodyCheckbox.click();
        expect(selectAllCheckbox.indeterminate).to.be.true;
      });

      it('should have indeterminate true when an item is deselected', function() {
        selectAllCheckbox.click();
        expect(selectAllCheckbox.indeterminate).to.be.false;

        firstBodyCheckbox.click();
        expect(selectAllCheckbox.indeterminate).to.be.true;
      });

      it('should select-all when all items are selected', function() {
        rows.forEach(function(row) {
          var cellContent = getCellContent(getRowCells(row)[0]);
          var checkbox = cellContent.children[0];
          checkbox.click();
        })

        expect(selectionColumn.selectAll).to.be.true;
        expect(selectAllCheckbox.indeterminate).to.be.false;
      });

      it('should deselect-all when all items are deselected', function() {
        selectAllCheckbox.click();

        rows.forEach(function(row) {
          var cellContent = getCellContent(getRowCells(row)[0]);
          var checkbox = cellContent.children[0];
          checkbox.click();
        })

        expect(selectionColumn.selectAll).to.be.false;
        expect(selectAllCheckbox.indeterminate).to.be.false;
      });

    });
  </script>

</body>

</html>
