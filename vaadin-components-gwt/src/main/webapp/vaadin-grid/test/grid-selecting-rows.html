<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <title></title>
  <script src="../../bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
  <script src="../../bower_components/web-component-tester/browser.js"></script>
  <script src="../../VaadinGrid/VaadinGrid.nocache.js"></script>
  <script src="common.js"></script>

  <link rel="import" href="../vaadin-grid.html">
</head>
<body>

<div id="gridwrapper"></div>

<script>
  describe.feature('selecting rows', function() {
    var selectListener;

    beforeEach(function() {
      selectListener = sinon.spy();
      grid.addEventListener('select', selectListener);
    });

    function getSelectionModeAttr() {
      return grid.getAttribute('selection-mode');
    };

    function getSelectedRowsAttr() {
      return grid.getAttribute('selected-rows');
    };

    function setSelectionModeAttr(mode) {
      grid.setAttribute('selection-mode', mode);

      return grid;
    };

    function setSelectedRowsAttr(rows) {
      grid.setAttribute('selected-rows', rows);

      return grid;
    };

    describe('using attributes', function() {
      describe('selection-mode', function() {
        it('should set selectionMode to none', function() {
          return setSelectionModeAttr('none').then(function() {
            expect(grid.selectionMode).to.equal('none');
          });
        });

        it('should set selectionMode to single', function() {
          return setSelectionModeAttr('single').then(function() {
            expect(grid.selectionMode).to.equal('single');
          });
        });

        it('should set selectionMode to multi', function() {
          return setSelectionModeAttr('multi').then(function() {
            expect(grid.selectionMode).to.equal('multi');
          });
        });

        it('should should remove selectionMode property', function() {
          setSelectionModeAttr('none');

          grid.removeAttribute('selection-mode');

          return grid.then(function() {
              // 'single' is the default
              expect(grid.selectionMode).to.equal('single');
            });
        });

        // TODO: throws an error, but for some reason expect doesn't catch it.
        it.skip('should fail setting the value to foobar', function() {
          expect(function() {
            setSelectionModeAttr('foobar');
          }).to.throw(Object);
        });
      });

      describe('selected-rows', function() {
        describe('with mode: single', function() {
          beforeEach(function() {
            return setSelectionModeAttr('single');
          });

          it('should set a single value to selectedRows', function() {
            return setSelectedRowsAttr('0').then(function() {
              expect(grid.selectedRows).to.contain(0);
            });
          });

          it('should set the last value to selectedRows', function() {
            return setSelectedRowsAttr('0,1').then(function() {
              expect(grid.selectedRows).to.contain(1);
            });
          });

          it('should set empty to selectedRows when setting empty value', function() {
            setSelectedRowsAttr('0');

              return setSelectedRowsAttr('').then(function() {
                expect(grid.selectedRows).to.be.empty;
            });
          });

          // TODO: https://github.com/vaadin/components/issues/3
          it.skip('should set empty to selectedRows when removing attribute', function() {
            setSelectedRowsAttr('0');

            grid.removeAttribute('selected-rows');

            return grid.then(function() {
              expect(grid.selectedRows).to.be.empty;
            });
          });
        });

        describe('with selection-mode: multi', function() {
          beforeEach(function() {
            return setSelectionModeAttr('multi');
          });

          it('should set a single value to selectedRows', function() {
            return setSelectedRowsAttr('1').then(function() {
              expect(grid.selectedRows).to.include(1);
            });
          });

          it('should set multiple values to selectedRows', function() {
            return setSelectedRowsAttr('0 , 1').then(function() {
              expect(grid.selectedRows).to.include.members([0,1]);
            });
          });

          it('should set empty to selectedRows', function() {
            return setSelectedRowsAttr('').then(function() {
              expect(grid.selectedRows).to.be.empty;
            });
          });

          it('should leave out invalid values', function() {
            return setSelectedRowsAttr('1, foobar, 0').then(function() {
              expect(grid.selectedRows).to.include.members([0,1]);
              expect(grid.selectedRows).to.not.include('foobar');
            });
          });
        });

        describe('with selection-mode: none', function() {
          beforeEach(function() {
            return setSelectionModeAttr('none');
          });

          it('should not set any rows', function() {
            return setSelectedRowsAttr('0').then(function() {
              expect(grid.selectedRows).to.be.empty;
            });
          });
        });
      });
    });

    describe('using properties', function() {
      describe('selectionMode', function() {
        var checkBoxQuery = "input[type='checkbox']";

        it('should be single by default', function() {
          expect(grid.selectionMode).to.equal('single');
        });

        it('should be use default value when removing the value', function() {
          grid.selectionMode = 'none';

          grid.selectionMode = undefined;

          expect(grid.selectionMode).to.equal('single');
        });

        it('should set selection-mode to none', function() {
          grid.selectionMode = 'none';

          return grid.then(function() {
            expect(getSelectionModeAttr()).to.equal('none');
            expect(qLocal(checkBoxQuery)).to.be.undefined;
          });
        });

        it('should set selection-mode to single', function() {
          grid.selectionMode = 'single';

          return grid.then(function() {
            expect(getSelectionModeAttr()).to.equal('single');
            expect(qLocal(checkBoxQuery)).to.be.undefined;
          });
        });

        it('should set selection-mode to multi', function() {
          grid.selectionMode = 'multi';

          return grid.then(function() {
            expect(getSelectionModeAttr()).to.equal('multi');
            expect(qLocal(checkBoxQuery)).to.not.be.undefined;
          });
        });

        it('should fail setting the value to foobar', function() {
          expect(function() {
            grid.selectionMode = 'foobar';
          }).to.throw(Object);
        });
      });

      describe('selectedRows', function() {
        it('should add \'row-selected\' class to the selected row', function() {
          grid.selectedRows = [1];

          return grid.then(function() {
            expect(qaLocal('.v-grid-body .v-grid-row-selected')).to.have.length(1);
          });
        });

        it('should fire \'select\' event', function() {
          grid.selectedRows = [0];

          expect(selectListener.args[0][0]).to.have.property('type', 'select');
        });

        it('should cache selectedRows until data source is loaded', function(done) {
          grid.data.source = function(req) {
            expect(grid.selectedRows).to.eql([0,1,2]);

            req.success(['foo'], 1);

            expect(grid.selectedRows).to.eql([0]);
            done();
          };

          grid.selectionMode = 'multi';
          grid.selectedRows = [0,1,2];
        });

        describe('with mode: single', function() {
          beforeEach(function() {
            grid.selectionMode = 'single';

            return grid;
          });

          it('should set a single value to selected-rows', function() {
            grid.selectedRows = [1];

            return grid.then(function() {
              expect(getSelectedRowsAttr()).to.equal('1');
            });
          });

          it('should set the last value from an array to selected-rows', function() {
            grid.selectedRows = [0,1];

            return grid.then(function() {
              expect(getSelectedRowsAttr()).to.equal('1');
            });
          });

          it('should clear the selected-rows value when given an invalid row', function() {
            grid.selectedRows = [1];

            grid.selectedRows = 'foobar';

            return grid.then(function() {
              expect(getSelectedRowsAttr()).to.equal('');
            });
          });

          it('should clear the selection when changing mode to none', function() {
            grid.selectedRows = [0];

            grid.selectionMode = 'none';

            expect(grid.selectedRows).to.be.empty;
          });

          it('should clear selection when changing mode to multi', function() {
            grid.selectedRows = [1];

            grid.selectionMode = 'multi';

            expect(grid.selectedRows).to.be.empty;
          });
        });

        describe('with selectionMode: multi', function() {
          beforeEach(function () {
            grid.selectionMode = 'multi';

            return grid;
          });

          it('should set a single value to selection-mode', function() {
            grid.selectedRows = [1];

            return grid.then(function() {
              expect(getSelectedRowsAttr()).to.equal('1');
            });
          });

          it('should set multiple values to selection-mode', function() {
            grid.selectedRows = [0,1];

            return grid.then(function() {
              expect(getSelectedRowsAttr()).to.equal('0,1');
            });
          });

          // TODO: https://github.com/vaadin/components/issues/2
          it.skip('should remove selection-mode when set to undefined', function() {
            grid.selectedRows = [0];

            grid.selectedRows = undefined;

            return grid.then(function() {
              expect(grid.getAttribute('selected-rows')).to.be.undefined;
            });
          });

          it('should set selection-mode to empty', function() {
            grid.selectedRows = [0];

            grid.selectedRows = [];

            return grid.then(function() {
              expect(getSelectedRowsAttr()).to.be.empty;
            });
          });

          it('should fire a \'select\' event', function() {
            grid.selectedRows = [0,1];

            expect(selectListener.calledOnce).to.be.true;
          });

          it('should clear the selection when changing mode to none', function() {
            grid.selectedRows = [0,1];

            grid.selectionMode = 'none';

            expect(grid.selectedRows).to.be.empty;
          });

          it('should clear selection when changing mode to single', function() {
            grid.selectedRows = [1];

            grid.selectionMode = 'single';

            expect(grid.selectedRows).to.be.empty;
          });

          it('should remove multiple selections when changing mode to single', function() {
            grid.selectedRows = [0,1];

            grid.selectionMode = 'single';

            expect(grid.selectedRows).to.be.empty;
          });
        });

        describe('with selectionMode: none', function() {
          beforeEach(function() {
            grid.selectionMode = 'none';
          });

          it('should not select any rows', function() {
            grid.selectedRows = [0];

            expect(getSelectedRowsAttr()).to.equal('');
          });
        });
      });
    });

    describe('by clicking', function() {
      function getFirstCell() {
        return qLocal('.v-grid-body .v-grid-cell');
      }

      function clickFirstCell() {
        return getFirstCell().click();
      }

      it('should fire a \'select\' event', function() {
        clickFirstCell();

        expect(selectListener.calledOnce).to.be.true;
      });

      describe('with selection-mode: single', function() {
        beforeEach(function() {
          setSelectionModeAttr('single');
        });

        it('should select a row', function() {
          clickFirstCell();

          expect(getSelectedRowsAttr()).to.equal('0');
        });

        it('should deselect the row on clicking again', function() {
          clickFirstCell();

          clickFirstCell();

          expect(getSelectedRowsAttr()).to.be.empty;
        });
      });

      describe('with selection-mode: multi', function() {
        beforeEach(function() {
          setSelectionModeAttr('multi');
        });

        it('should only focus a clicked cell', function() {
          clickFirstCell();

          expect(getSelectedRowsAttr()).to.equal('');
          expect(getFirstCell().getAttribute('class')).to.contain('focus');
        });

        // TODO: apparently clicking checkboxes isn't going to happen using JS...
        it.skip('should select multiple rows', function() {
          var inputs = qaLocal('input');
          inputs[0].checked = true;
          inputs[1].click();

          expect(getSelectedRowsAttr()).to.equal('0,1');
        });
      });

      describe('with selection-mode: none', function() {
        beforeEach(function() {
          setSelectionModeAttr('none');
        });

        it('should not select a row', function() {
          clickFirstCell();

          expect(getSelectedRowsAttr()).to.equal('');
        });
      });
    });

    describe('by using API', function() {
      it('should fire a \'select\' event', function() {
        grid.select(0);

        expect(selectListener.calledOnce).to.be.true;
      });

      it('should not select invalid row', function() {
        grid.select('foo');

        expect(getSelectedRowsAttr()).to.equal('');
      });

      describe('with selectionMode: single', function() {
        beforeEach(function() {
          grid.selectionMode = 'single';
        });

        it('should select a row', function() {
          grid.select(1);

          expect(getSelectedRowsAttr()).to.equal('1');
        });

        it('should select another row', function() {
          grid.select(1);
          grid.select(0);

          expect(getSelectedRowsAttr()).to.equal('0');
        });
      });

      describe('with selectionMode: multi', function() {
        beforeEach(function() {
          grid.selectionMode = 'multi';
        })

        it('should select multiple rows', function() {
          grid.select(0);
          grid.select(1);

          expect(getSelectedRowsAttr()).to.equal('0,1');
        });
      });

      describe('with selectionMode: none', function() {
        beforeEach(function() {
          grid.selectionMode = 'none';
        });

        it('should not select a row', function() {
          grid.select(0);

          expect(getSelectedRowsAttr()).to.equal('');
        });
      });
    });

    describe('deselecting rows using API', function() {
      it('should fire \'select\' event', function() {
        grid.selectedRows = [0];

        grid.deselect(0);

        expect(selectListener.calledTwice).to.be.true;
      });

      describe('with selectionMode: single', function() {
        beforeEach(function() {
          grid.selectionMode = 'single';
        });

        it('should deselect a row', function() {
          grid.selectedRows = [0];

          grid.deselect(0);

          expect(grid.selectedRows).to.be.empty;
        });

        it('should not deselect other rows', function() {
          grid.selectedRows = [0];

          grid.deselect(1);

          expect(getSelectedRowsAttr()).to.equal('0');
        });
      });

      describe('with selectionMode: multi', function() {
        beforeEach(function() {
          grid.selectionMode = 'multi';
        });

        it('should deselect a single row', function() {
          grid.selectedRows = [0,1];

          grid.deselect(0);

          expect(getSelectedRowsAttr()).to.equal('1');
        });
      });
    });
  });
</script>
</body>
</html>