<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <script>
    PolymerSettings = {
      //shadow: true
    };
  </script>

  <script src="../../bower_components/webcomponentsjs/webcomponents.min.js"></script>
  <script src="../../bower_components/web-component-tester/browser.js"></script>
  <link rel="import" href="../../bower_components/polymer/src/expr/polymer-expr.html">
  <script src="../../VaadinGrid/VaadinGrid.nocache.js"></script>

  <link rel="import" href="../vaadin-grid.html">
</head>

<body>
  <script>
    function waitUntilGridReady(cb) {
      if (window.vaadin && vaadin._v_grid_ready) {
        cb();
      } else {
        document.addEventListener("v-grid-ready", function() {
          cb();
        });
      }
    }

    function waitUntil(check, exec, onTimeout) {
      var id = setInterval(function() {
        if (check()) {
          clearInterval(id);
          clearTimeout(timeoutId);
          exec();
        }
      }, 100);

      var timeoutId = setTimeout(function() {
        clearInterval(id);
        assert.fail();
        onTimeout();
      }, 5000);
    }
  </script>

  <div id="gridwrapper"></div>

  <script>
    suite('vaadin-grid', function() {
      var grid, wrapper;

      function removeGrid() {
        if (grid) {
          grid.style.visibility = "hidden";
          document.body.appendChild(grid);
          grid = null;
        }
      }

      var local = function() {
        return Polymer.dom(grid.root);
      };
      var light = function() {
        return Polymer.dom(grid);
      };

      var qLocal = function(selector) {
        return local().querySelector(selector);
      };
      var qaLocal = function(selector) {
        return local().querySelectorAll(selector);
      };
      var qLight = function(selector) {
        return light().querySelector(selector);
      };


      setup(function(done) {
        removeGrid();

        wrapper = document.getElementById("gridwrapper");
        wrapper.innerHTML = "<v-grid><table><thead><tr><th>Name</th><th>Value</th></tr></thead>" +
          "<tbody><tr><td>Grid</td><td>10000</td></tr><tr><td>VaadinX</td><td>1000</td></tr></tbody></table></v-grid>";
        grid = wrapper.querySelector("v-grid");

        waitUntilGridReady(function() {
          // in each iteration we need to sleep a while so as all
          // asynchronous processes in the grid initialization finish
          setTimeout(done, 200);
        });
      });

      test.skip('redraw', function(done) {
        function width(e) {
          return pxval(e, 'width');
        }

        function height(e) {
          return pxval(e, 'height');
        }

        function pxval(e, prop) {
          return parseInt(e.ownerDocument.defaultView.getComputedStyle(e).getPropertyValue(prop).replace('px', ''));
        }

        function assertSameDimensions() {
          return width(grid) == width(inner) && height(grid) == height(inner);
        }

        function assertHeightByRows(rows) {
          h = height(inner);
          h1 = headers * thHeight + rows * tdHeight;
          // IE and FF add an aditional pixel to each row
          h2 = h1 + rows + headers;
          return h == h1 || Â h == h2;
        }

        var inner = qLocal("div.v-grid");
        var tbody = qLight('table tbody');
        var thHeight = height(qLocal('thead tr th'));
        var headers = qaLocal('thead tr').length;
        var tdHeight = height(qLocal('tbody tr td'));

        assert.isTrue(assertSameDimensions());
        assert.isTrue(assertHeightByRows(2));

        // Increase the number of rows
        tbody.innerHTML += tbody.innerHTML;
        tbody.innerHTML += tbody.innerHTML;
        tbody.innerHTML += tbody.innerHTML;
        tbody.innerHTML += tbody.innerHTML;
        // Maybe DOM.observer polyfill was not loaded
        grid.grid.refresh();

        grid.then(function() {
            assert.isTrue(assertSameDimensions());
            // grid has a limit of 10 data rows by default
            assert.isTrue(assertHeightByRows(10));

            // Restrict height by rows
            grid.rows = 3;
            return grid;
        }).then(function() {
          assert.isTrue(assertSameDimensions());
          assert.isTrue(assertHeightByRows(3));
          // unrestrict height by rows
          grid.rows = 0;
          return grid;
        }).then(function() {
          assert.isTrue(assertSameDimensions());
          assert.isTrue(assertHeightByRows(10));

          // Set fixed sizes
          grid.style.width = '300px';
          grid.style.height = '100px';
          return grid;
        }).then(function() {
          assert.isTrue(assertSameDimensions());

          // Cover all the page
          grid.style.position = 'absolute';
          grid.style.width = '100%';
          grid.style.height = '100%';
          return grid;
        }).then(function() {
          assert.isTrue(assertSameDimensions());
          assert.equal(document.body.clientHeight, height(grid));
          // For some reason in IE sometimes there is a slight difference of 1 pixels
          assert.isTrue(Math.abs(document.body.clientWidth - width(grid)) <= 1);
          // We can have different height for v-grid and the inner grid.
          // Also we can define more than 10 rows.
          grid.rows = 12;
          grid.style.width = '50%';
          return grid;
        }).then(function() {
          assert.isTrue(height(grid) != height(inner));
          assert.equal(width(grid), width(inner));
          assert.isTrue(assertHeightByRows(12));
          assert.isFalse(assertSameDimensions());
        }).then(done);
      });

      test('DOM: headers & footers', function(done) {
        removeGrid();
        wrapper.innerHTML = "<v-grid><table>" +
          "<thead hidden><tr class='red'><td colspan='2'></td></tr><tr class='pink'><th></th><th></th></tr></thead>" +
          "<tfoot><tr class='foot1'><td colspan='2'></td></tr><tr class='foot2'><td></td><td></td></tr></tfoot>" +
          "</table></v-grid>";
        grid = wrapper.querySelector("v-grid");

        waitUntil(function() {
          return qLocal(".v-grid-body");
        }, function() {
          assert.equal(0, qaLocal("thead tr").length);
          assert.equal(1, qaLocal("tfoot tr.foot1").length);
          assert.equal(1, qaLocal("tfoot tr.foot2").length);
          assert.equal(1, qaLocal("tfoot td[colspan='2']").length);

          qLight("thead").setAttribute('hidden', false)
          waitUntil(function() {
            return qaLocal("thead tr").length > 0;
          }, function() {
            assert.equal(1, qaLocal("thead tr.red").length);
            assert.equal(1, qaLocal("thead tr.pink").length);
            assert.equal(1, qaLocal("thead th[colspan='2']").length);
            done();
          }, done);

        }, done);
      });

      test('DOM: mutation', function(done) {
        waitUntil(function() {
          return qLocal(".v-grid-body");
        }, function() {
          var nrows = qaLocal("tbody tr").length;
          var nheads = qaLocal("thead tr").length;
          qLight("thead").innerHTML += qLight("table thead").innerHTML;
          qLight("tbody").innerHTML += qLight("table tbody").innerHTML;
          assert.equal("Name", qLocal("th").textContent);
          qLight("th").textContent = "foo";
          waitUntil(function() {
            return qLocal("tbody tr") && qaLocal("tbody tr").length == nrows * 2;
          }, function() {
            assert.equal(qaLocal("tbody tr").length, nrows * 2);
            assert.equal(qaLocal("thead tr").length, nheads * 2);
            assert.equal("foo", qLocal("th").textContent);
            done();
          }, done);
        }, done);
      });

    });
  </script>

</body>

</html>
