<script>
  window.vaadin = window.vaadin || {};
  vaadin.elements = vaadin.elements || {};
  vaadin.elements.grid = vaadin.elements.grid || {};

  /**
   * @polymerBehavior vaadin.elements.grid.CellClickBehavior
   */
  vaadin.elements.grid.CellClickBehavior = {

    listeners: {
      'click': '_onClick'
    },

    // we need to listen to click instead of tap because on mobile safari, the
    // document.activeElement has not been updated (focus has not been shifted)
    // yet at the point when tap event is being executed.
    _onClick: function(e) {
      // Prevent item action if cell itself is not focused.
      if (this._cellClick) {
        if (Polymer.Settings.useNativeShadow) {
          if (!this._isFocusable(Polymer.dom(e).localTarget)) {
            this._cellClick(e);
          }
        } else {
          var path = Polymer.dom(e).path;
          var elementsClicked = path.slice(0, path.indexOf(Polymer.dom(e).localTarget) + 1);
          if (!elementsClicked.some(this._isFocusable)) {
            this._cellClick(e);
          }
        }
      }
    },

    _isFocusable: function(target) {
      return target.nodeType === Node.ELEMENT_NODE &&
             target.matches(':not([disabled])') &&
             (target.matches('[tabindex]') ||
             target.matches('button, input, select, textarea, object, iframe, label') ||
             target.matches('a[href], area[href]'));
    }
  };
</script>
