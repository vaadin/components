<script>
  window.vaadin = window.vaadin || {};
  vaadin.elements = vaadin.elements || {};
  vaadin.elements.grid = vaadin.elements.grid || {};

  /**
   * @polymerBehavior vaadin.elements.grid.CellClickBehavior
   */
  vaadin.elements.grid.CellClickBehavior = {

    listeners: {
      'click': '_onClick'
    },

    // we need to listen to click instead of tap because on mobile safari, the
    // document.activeElement has not been updated (focus has not been shifted)
    // yet at the point when tap event is being executed.
    _onClick: function(e) {
      // Prevent item action if cell itself is not focused.
      if (this._cellClick) {
        var path = Polymer.dom(e).path;
        var elementsClicked = path.slice(0, path.indexOf(Polymer.dom(e).localTarget) + 1);
        if (!elementsClicked.some(this._isFocusable)) {
          this._cellClick(e);
        }
      }
    },

    _isFocusable: function(target) {
      // Polymer.dom(e).localTarget usually returns <content> element in shady
      // DOM. We'll get and use the cell-content wrapper in that case.
      if (target.getDistributedNodes) {
        target = Polymer.dom(target).getDistributedNodes()[0];
      }

      return target.contains(Polymer.dom(document.activeElement).node) ||
             target.matches &&
             target.matches(':not([disabled])') &&
             (target.matches('[tabindex]') ||
             target.matches('button, input, select, textarea, object, iframe, label') ||
             target.matches('a[href], area[href]'));
    }
  };
</script>
